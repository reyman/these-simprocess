% !TEX encoding =  UTF-8 Unicode
% -*- program: xelatex -*-
\documentclass[a4paper, 11pt,twoside, openright]{memoir}
\usepackage{polyglossia}
\setdefaultlanguage{french}
\setotherlanguage{english}
\setotherlanguage[variant=ancient]{greek}
\setotherlanguage{latin}
\usepackage{fontspec}
\usepackage[usenames,dvipsnames]{xcolor}
\usepackage[autostyle=true,french=guillemets,maxlevel=3]{csquotes}
\usepackage{xparse}
\usepackage{graphicx}
\usepackage[protrusion=true]{microtype}
\usepackage{soul}
\usepackage{minted}
\usepackage[ruled,vlined,linesnumbered]{algorithm2e}
\usepackage{amssymb}
\usepackage{amsmath,mathtools}
%\usepackage{showframe}
\usepackage{enumitem}


\newsubfloat{figure}

\definecolor{fftttt}{rgb}{1,0.2,0.2}
\definecolor{ttttff}{rgb}{0.2,0.2,1}
\definecolor{cqcqcq}{rgb}{0.75,0.75,0.75}
\usepackage{pgf,tikz}
\usetikzlibrary{arrows}

\setcounter{equation}{0}

%http://tex.stackexchange.com/questions/144943/footnote-non-inline-syntax
\usepackage{sepfootnotes}
\newfootnotes{A}

%\usepackage[notes,natbib,isbn=false,backend=biber]{biblatex-chicago}  
%,style=authortitle-dw
%http://tex.stackexchange.com/questions/16765/biblatex-author-year-square-brackets
\usepackage[backend=biber,backref=true, natbib=true, isbn=false, doi=true, url=true, style=authoryear,maxcitenames=1, maxbibnames=999, sorting=nyt, refsection=chapter, hyperref]{biblatex}

\setparaheadstyle{\normalsize\itshape}
\setafterparaskip{1ex}

%% QUOTE FRENCH ITALICS
\makeatletter

\newcommand{\FrameTitle}[2]{%
\fboxrule=\FrameRule \fboxsep=\FrameSep
\fbox{\vbox{\nobreak \vskip -0.7\FrameSep
\rlap{\strut#1}\nobreak\nointerlineskip% left justified
\vskip 0.7\FrameSep
\hbox{#2}}}}
\newenvironment{framewithtitle}[2][\FrameFirst@Lab\ (cont.)]{%
\def\FrameFirst@Lab{\textbf{#2}}%
\def\FrameCont@Lab{\textbf{#1}}%
\def\FrameCommand##1{%
\FrameTitle{\FrameFirst@Lab}{##1}}%
\def\FirstFrameCommand##1{%
\FrameTitle{\FrameFirst@Lab}{##1}}%
\def\MidFrameCommand##1{%
\FrameTitle{\FrameCont@Lab}{##1}}%
\def\LastFrameCommand##1{%
\FrameTitle{\FrameCont@Lab}{##1}}%
\MakeFramed{\advance\hsize-\width \FrameRestore}}%
{\endMakeFramed}
\makeatother

%% QUOTE FRENCH ITALICS
\DeclareQuoteStyle{english}
  {\mkfrenchopenquote{\guillemotleft}\itshape}
  {\itshape\mkfrenchclosequote{\guillemotright}}
  {\textquotedblleft\itshape}
  {\itshape\textquotedblright}

%% QUOTE LATIN ITALICS
\DeclareQuoteStyle{latin}
  {\mkfrenchopenquote{\guillemotleft}\em}
  {\em\mkfrenchclosequote{\guillemotright}}
  {\textquotedblleft\em}
  {\em\textquotedblright}

\definecolor{shadecolor}{gray}{0.9}

%\footnotesinmargin
\footmarkstyle{[#1]~}
\setlength{\footmarkwidth}{-1sp}
\setlength{\footmarksep}{0pt}
\setlength{\footparindent}{0pt}
\renewcommand{\foottextfont}{\scriptsize\raggedright}

\sidecapmargin{outer}
\setsidecappos{t}

%%SIDE CAPTION LITTLE START

%\def\mybibdoicolor{\color{blue!75!black}} %change color to suit.

% \DeclareSourcemap{
%   \maps[datatype=bibtex]{
%     \map{
%       \step[ % copies url to doi field if it starts with http://dx.doi.org/
%         fieldsource=url,
%         match=\regexp{http://dx.doi.org/(.+)},
%         fieldtarget=doi,
%       ]
%     \step[ % removes http://dx.doi.org/ string from doi field
%       fieldsource=doi,
%       match=\regexp{http://dx.doi.org/(.+)},
%       replace=\regexp{$1}
%     ]
%     }
%   \map{ % removes url + urldate field from all entries that have a doi field
%    \step[fieldsource=doi, final]
%    \step[fieldset=url, null]
%    \step[fieldset=urldate, null]
%    }
%  }
% }

\DefineBibliographyStrings{french}{%
  url = {@Téléchargement},
}

\DeclareFieldFormat{url}{%
  \ifhyperref
    {\href{#1}{\bibstring{url}}}
    {\url{#1}}}

\DeclareSourcemap{
  \maps[datatype=bibtex]{
    \map[overwrite]{
      \step[fieldsource=file]
      \step[fieldset=url, origfieldval]
      \step[fieldsource=url, match=\regexp{\\_}, replace=\regexp{_}]
      \step[fieldsource=url, 
        match=\regexp{:home/srey/TRAVAUX/THESE/REPOSITORY_PDF/RANGE/(.+):\w*$},
        replace={http://bib.unthinkingdepths.fr/$1}]
    }
  }  
}

%% JUSTIFICATION PART OF SIDE CAPTION
%% http://tex.stackexchange.com/questions/165740/reduce-size-and-justify-font-of-caption-using-memoir
\usepackage{ragged2e}

\renewcommand*{\sidecapstyle}{%
 \ifscapmargleft
    \captionstyle{\justifying\scriptsize}%
  \else
    \captionstyle{\justifying\scriptsize}%
  \fi}

%%SIDE CAPTION LITTLE END


\addbibresource[datatype=bibtex]{Library/library.bib}

%\tolerance=1000

%%SIDEAWAY START
% \renewcommand*{\sidecapstyle}{%
% \captionnamefont{\bfseries}%
% \slshape%
% }

% \renewcommand*{\sidecapfloatwidth}{0.5\linewidth}
% \setsidecaps{0.1\textwidth}{.55\textwidth}
% \sidecapmargin{outer}
% \setsidecappos{b}
% \strictpagecheck
% \sidecapraise 0.05\textheight

% \newrobustcmd*{\parentexttrack}[1]{%
%   \begingroup
%   \blx@blxinit
%   \blx@setsfcodes
%   \blx@bibopenparen#1\blx@bibcloseparen
%   \endgroup}

% \AtEveryCite{%
%   \let\parentext=\parentexttrack%
%   \let\bibopenparen=\bibopenbracket%
%   \let\bibcloseparen=\bibclosebracket}
%%SIDEAWAY END

%%SIDECAPTION START
%% http://blog.oak-tree.us/index.php/2011/03/26/latex01-raggedmarginalia
% \makeatletter
% \newcounter{pl}
% \newcommand\ragmarpar[1]{%
% \stepcounter{pl}\label{pl-\thepl}%
% \ifthenelse{\isodd{\pageref{pl-\thepl}}}%
% {\marginpar{\raggedright #1}}
% {\marginpar{\raggedleft #1}}
% }
% \renewcommand*{\sidecapstyle}{%
% \stepcounter{pl}\label{pl-\thepl}%
% \ifthenelse{\isodd{\pageref{pl-\thepl}}}%
% {\captionstyle{\raggedright}}
% {\captionstyle{\raggedleft}}}
% %%SIDECAPTION END
% \makeatother

\makeatletter
%\renewcommand{\fnum@figure}[1]{\textbf{\figurename~\thefigure}}
\renewcommand{\fnum@figure}{\textbf{Figure~\thefigure~--}}
\makeatother

%\precaption{\raggedright}
%\setlength{\belowcaptionskip}{\onelineskip}
\setlength{\footnotesep}{\onelineskip}

%% FOOTNOTE COLORING START
\makeatletter
\renewcommand\@makefnmark{\hbox{\@textsuperscript{\normalfont\color{BurntOrange}\@thefnmark}}}
%\renewcommand\@makefntext[1]{%
%  \parindent 1em\noindent
%            \hb@xt@1.8em{%
%                \hss\@textsuperscript{\normalfont\@thefnmark}}#1}
%% FOOTNOTE COLORING END
\makeatother

%\makeatletter
%	\renewcommand*\@makefnmark{{\normalfont (\@thefnmark)}}
%\makeatother 



%\makeatletter \renewcommand\@makefntext[1]{ %
%\noindent\makebox[0.2em][r]{\@makefnmark}#1} 
%\makeatother

\newcommand{\longfullcite}{%
\AtNextCite{\defcounter{maxnames}{99}}%
\fullcite}

\setcounter{secnumdepth}{3}

%Controle minitoc
\setcounter{tocdepth}{3}

% % EPIGRAPH 1
\usepackage{epigraph}
\setlength\epigraphwidth{8cm}
\setlength\epigraphrule{0pt}
\usepackage{etoolbox}

\patchcmd{\epigraph}{\@epitext{#1}}{\itshape\@epitext{#1}}{}{}

% % EPIGRAPH 2

%\usepackage{epigraph,varwidth}
%
%\renewcommand{\epigraphsize}{\small}
%\setlength{\epigraphwidth}{0.6\textwidth}
%\renewcommand{\textflush}{flushright}
%\renewcommand{\sourceflush}{flushright}
%% A useful addition
%\newcommand{\epitextfont}{\itshape}
%\newcommand{\episourcefont}{\scshape}
%
%\makeatletter
%\newsavebox{\epi@textbox}
%\newsavebox{\epi@sourcebox}
%\newlength\epi@finalwidth
%\renewcommand{\epigraph}[2]{%
%\vspace{\beforeepigraphskip}
%{\epigraphsize\begin{\epigraphflush}
%\epi@finalwidth=\z@
%\sbox\epi@textbox{%
%\varwidth{\epigraphwidth}
%\begin{\textflush}\epitextfont#1\end{\textflush}
%\endvarwidth
%}%
%\epi@finalwidth=\wd\epi@textbox
%\sbox\epi@sourcebox{%
%\varwidth{\epigraphwidth}
%\begin{\sourceflush}\episourcefont#2\end{\sourceflush}%
%\endvarwidth
%}%
%\ifdim\wd\epi@sourcebox>\epi@finalwidth 
%\epi@finalwidth=\wd\epi@sourcebox
%\fi
%\leavevmode\vbox{
%\hb@xt@\epi@finalwidth{\hfil\box\epi@textbox}
%\vskip1.75ex
%\hrule height \epigraphrule
%\vskip.75ex
%\hb@xt@\epi@finalwidth{\hfil\box\epi@sourcebox}
%}%
%\end{\epigraphflush}
%\vspace{\afterepigraphskip}}}
%\makeatother
%\NewDocumentCommand\trule{O{0.4pt}O{0pt}}{
%\vskip0pt\vtop to0pt{
%\noindent\raisebox{#2}{\vbox{\leavevmode\hrule height#1}}}
%}

\defaultfontfeatures{Scale=MatchLowercase,Mapping=tex-text}

\setmainfont[Mapping=tex-text, % E.g. -- -> en-dash
Numbers=OldStyle,
UprightFeatures={LetterSpace=-0.9},
ItalicFeatures={LetterSpace=0.9},    % To cancel -0.9 tracking
SmallCapsFeatures={LetterSpace=10.0},
%]{Ubuntu}
]{Garamond Premier Pro}

\nonzeroparskip

%\linespread{1.125}\selectfont

%%% Package pour les sources des figures (subfloat)
% Incompatible with FIGURE NAME
%\usepackage[format=hang,  font={small, rm,md,sl}, margin=5pt, singlelinecheck=false, labelformat=empty]{subfig}

%%% Package pour faire des mini tables des matières 
\usepackage{titletoc}

%http://tex.stackexchange.com/questions/66796/how-to-get-two-tableofcontents-general-and-detailled/66806#66806
%\usepackage[explicit]{titlesec}

% %TEXT BIDON
\usepackage{lipsum}

%%% Package pour les sites internet
\usepackage{url}

\definecolor{light-gray}{gray}{0.85}
\definecolor{colboxcolor}{gray}{0.9}

%http://tex.stackexchange.com/questions/66796/how-to-get-two-tableofcontents-general-and-detailled/66806#66806
\usepackage[explicit]{titlesec}
%\titleformat{name=\section,numberless} {\normalfont\Large\bfseries}{}{0em}{#1\addcontentsline{ptc}{section}{#1}}
%\titleformat{name=\section} {\normalfont\Large\bfseries}{}{0em}{#1\addcontentsline{ptc}{section}{#1}}

\pagestyle{ruled}

\makeatletter
\newcommand\partialtocname{ Table des mati\`eres}
\newcommand\ToCrule{\noindent\rule[5pt]{\textwidth}{1.3pt}}
\newcommand\ToCtitle{{\large\bfseries\partialtocname}\vskip2pt\ToCrule}
\makeatletter
\newcommand\Mprintcontents{%
\ToCtitle
\ttl@printlist[chapters]{toc}{}{1}{}\par\nobreak
\ToCrule}
\makeatother


%http://en.wikibooks.org/wiki/LaTeX/Hyperlinks
%http://tex.stackexchange.com/questions/17218/make-hyperref-take-pdfinfo-from-title-and-author
\usepackage[hidelinks, pdfusetitle]{hyperref} % Creates hyperlinks and index in the PDF document, preferably load after biblatex
\usepackage{ifnextok}
\usepackage{xcolor}

\def\mybibdoicolor{\color{BurntOrange}} %change color to suit.
\newcommand*{\doi}[1]{\href{http://dx.doi.org/\detokenize{#1} {\raggedright\mybibdoicolor{DOI: \detokenize{#1}}}}}

\usepackage[colorinlistoftodos]{todonotes}

%%START ORANGE TEXT FOR LINK
\makeatletter
\def\tilblank#1{#1\IfNextToken\@sptoken{ \color{black}}{%
  \IfNextToken\egroup{}{\tilblank}}}
\makeatother
\let\svat @
\catcode`@=\active
\def@{\color{BurntOrange}\svat\tilblank}
%%END ORANGE TEXT FOR LINK

\begin{document}

\chapterstyle{bringhurst}

\listoftodos

%\setupshortlof

\renewcommand\contentsname{Introduction}
\tableofcontents

%\listoftables
%\listoffigures

\include{Partie0}

\include{Partie1}

%\include{Partie2}

%\include{Partie3}

\include{Annexes}

%\bibliography{biblihadri_v1}

\listoftables

\listoffigures

\printbibliography

\end{document}
